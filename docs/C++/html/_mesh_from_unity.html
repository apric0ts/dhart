<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Analysis: Reading a Mesh From Unity</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Analysis
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Reading a Mesh From Unity </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Previous Tutorial: <a class="el" href="_generating_a_graph.html">The Graph Generator</a></p>
<ul>
<li><a href="#reading-a-mesh-from-unity-meshfromunity">Reading a Mesh From Unity {#MeshFromUnity}</a><ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#scene-setup">Scene Setup</a><ul>
<li><a href="#creating-the-plane">Creating the Plane</a></li>
<li><a href="#resetting-the-planes-position">Resetting the Plane's Position</a></li>
</ul>
</li>
<li><a href="#writing-the-script">Writing the Script</a><ul>
<li><a href="#set-usings">Set Usings</a></li>
<li><a href="#setup-for-adding-references-through-the-unity-inspector">Setup for adding references through the unity inspector</a></li>
<li><a href="#passing-meshes-from-gameobjects-to-humanfactors">Passing Meshes from GameObjects to HumanFactors</a><ul>
<li><a href="#getting-a-reference-to-the-mesh-held-by-a-specific-game-object">Getting a reference to the mesh held by a specific Game Object</a></li>
<li><a href="#getting-the-vertices-and-triangles-from-a-unity-mesh">Getting the vertices and triangles from a Unity Mesh</a></li>
<li><a href="#transforming-the-mesh-from-y-up-to-z-up">Transforming the Mesh from Y-Up to Z-Up</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#executing-the-script">Executing the Script</a><ul>
<li><a href="#adding-references-through-the-unity-inspector">Adding References Through the Unity Inspector</a></li>
<li><a href="#comparing-output">Comparing Output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md24"></a>
Intro</h1>
<p>This tutorial will demonstrate how to pass geometry from the scene in Unity to Human Factors. We'll be using the project created in the previous guide: H:/HFGitlab/Analysis/docs/C# Documentation/markdown/3_graph_generator.md "The Graph Generator", and we'll be using concepts covered in the previous guides.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Scene Setup</h1>
<p>Up until this point, we haven't needed to interact with the unity scene, aside script to the camera game object that's already there. In order for us to demonstrate reading geometry from the scene, we must first create geometry in the scene. For this example, we will create a plane in unity instead of creating our own plane in code.</p>
<p>To begin, open up the unity project from H:/HFGitlab/Analysis/docs/C# Documentation/markdown/3_graph_generator.md "The Graph Generator".</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/start_point.png" alt="Blank Scene" class="inline"/></p>
<p>From here we will create a new plane then translate it directly to the origin.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Creating the Plane</h2>
<p>Using the menubar at the top of the screen select GameObject &gt; 3D Object &gt; Plane.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/create_plane.png" alt="Plane Created" class="inline"/></p>
<p>Once clicked, a new 1x1 plane will be created, however it may not have been created at the origin exactly. For this tutorial we will reset the plane's position just be be sure it's always placed exactly in the same place.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Resetting the Plane's Position</h2>
<p>Left Click on the newly created plane and look at <b>Transform</b> header in the Inspector located at the right sidebar.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/look_at_transforms.png" alt="Transform Visible" class="inline"/></p>
<p>Under <b>Transform</b> you can see the plane's position, rotation and scale within the scene. To set the plane's position to the origin, left on the three dots to the right of the transform header, and select <em>Reset Position</em>.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/reset_position.png" alt="Reset Position" class="inline"/></p>
<p>After clicking that button, your plane should be moved to the origin like in the image below. Ensure the position, rotation and scale values in the transform section completely match those of the image.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/resetted_plane.png" alt="Plane After Reset Position" class="inline"/></p>
<p>Now that we have the plane ready to go, we can begin working on the script to get its vertices and triangles.</p>
<h1><a class="anchor" id="autotoc_md28"></a>
Writing the Script</h1>
<p>Open up the New Behavior script we created in the H:/HFGitlab/Analysis/docs/C# Documentation/markdown/3_graph_generator.md "previous tutorial"</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Set Usings</h2>
<p>Just like last time, we're going to declare which namespaces this script will use in the using section. GraphOnPlane will require the same usings as the previous project as well as the Graph Generator Namespace</p>
<div class="fragment"><div class="line">using HumanFactors.Geometry;</div>
<div class="line">using HumanFactors.RayTracing;</div>
<div class="line">using HumanFactors.GraphGenerator;</div>
<div class="line">using HumanFactors.SpatialStructures;</div>
</div><!-- fragment --><p>Your usings for this script should look like this.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/usings.png" alt="Empty Script" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md30"></a>
Setup for adding references through the unity inspector</h2>
<p>Before we can worry about generating the graph, first we need to get the mesh from the Plane Gameobject we created in the Unity Editor. There are many ways to reference a GameObject from a script code, but for this example we'll be setting up our script so we can select the mesh to use from the scene in the Unity Inspector. For now, all we need to do is declare a GameObject member for our new class as shown below.</p>
<div class="fragment"><div class="line">GameObject PlaneReference;</div>
</div><!-- fragment --><p><img src="../assets/walkthroughs/unity/4_graph_generator/PlaneReference.png" alt="PlaneReference" class="inline"/></p>
<p>Later we'll use the unity inspector to assign the plane we created in the scene to this object</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Passing Meshes from GameObjects to HumanFactors</h2>
<p>Now that we have a reference to the plane game object we want to use, we need to get the raw vertices and faces of plane so we can pass it to HumanFactors for use in the graph generator.</p>
<h3><a class="anchor" id="autotoc_md32"></a>
Getting a reference to the mesh held by a specific Game Object</h3>
<p>Before we can extract the triangles and vertices from one an instance of a Unity Mesh, we first need to get a reference to the Mesh itself. Doing this requires some understanding of Unity GameObjects and their components. Tabbing back over to Unity for a moment, clicking on the plane, then looking at the inspector in the right reveals that the plane we see in the scene isn't just a mesh, but is in fact a <a href="https://docs.unity3d.com/Manual/class-GameObject.html"><b>GameObject</b></a> comprised of several different components.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/plane_inspector.png" alt="PlaneReference" class="inline"/></p>
<p>As stated in the Unity Documentation:</p>
<blockquote class="doxtable">
<p>GameObjects are the fundamental objects in Unity that represent characters, props and scenery. They do not accomplish much in themselves but they act as containers for Components, which implement the real functionality. For example, a Light object is created by attaching a Light component to a GameObject. </p>
</blockquote>
<p>So in short, the GameObject for the plane won't give us the information we need. Instead we need to get a reference to the GameObject's component that carries the Mesh: The <a href="https://docs.unity3d.com/Manual/class-MeshFilter.html"><b>MeshFilter</b></a>. Thankfully getting a reference to a component of a Game Object is easy, all you need to do is call the <a href="https://docs.unity3d.com/ScriptReference/GameObject.GetComponent.html">GetComponent</a> member function of the game object you want to get a component from.</p>
<p>In our script we will store a reference to the plane's mesh filter in a variable creatively named <code>Filter</code> at the beginning of GraphOfPlane's Start() function like so:</p>
<div class="fragment"><div class="line">{C#}</div>
<div class="line">       MeshFilter Filter = PlaneReference.GetComponent&lt;MeshFilter&gt;();</div>
</div><!-- fragment --><p>Then we'll access the actual mesh carried by <code>Filter</code> by calling its .mesh property</p>
<div class="fragment"><div class="line">Mesh PlaneMesh = Filter.mesh;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md33"></a>
Getting the vertices and triangles from a Unity Mesh</h3>
<p>We're not out of the woods yet. For Human Factors to use a mesh it needs two things:</p>
<p>1) The (x,y,z) location of every vertex that comprises the mesh as an array of floats. 2) The Indexes for each triangle or "Face" of the mesh as an array of integers.</p>
<p>Fortunately, Unity provides an easy way to access the triangles of a mesh, but unfortunately the vertices only come in an array of Vector3. To simplify the process of converting the vertices to a suitable format, we will add a seperate method called "FlattenVertexArray" that will transform the array of Vector3 into an array of float ready for Human Factors.</p>
<p>Just above Start(), add the following Method:</p>
<div class="fragment"><div class="line">private float[] FlattenVertexArray(Vector3[] vertices)</div>
<div class="line">{</div>
<div class="line">    float[] return_array = new float[vertices.Length * 3];</div>
<div class="line">    for (int i = 0; i &lt; vertices.Length; i++)</div>
<div class="line">    {</div>
<div class="line">        int os = i * 3;</div>
<div class="line">        return_array[os] = vertices[i].x;</div>
<div class="line">        return_array[os + 1] = vertices[i].y;</div>
<div class="line">        return_array[os + 2] = vertices[i].z;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    return return_array;</div>
<div class="line">}</div>
</div><!-- fragment --><p><img src="../assets/walkthroughs/unity/4_graph_generator/flatten_vertex_array.png" alt="FlattenVertexArray" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md34"></a>
Transforming the Mesh from Y-Up to Z-Up</h3>
<p>But wait, there's one more step involved when directly pulling meshes from Unity. Another quick peek at the editor in the top right corner reveals that Unity's coordinate system is fundamentally different from the coordinate system needed by Human Factors.</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/unity_coordinate_system.png" alt="UnityCoords" class="inline"/> <img src="../assets/walkthroughs/unity/4_graph_generator/rhino_coordinates.png" alt="RhinoCoords" class="inline"/></p>
<p>The Graph Generator expects geometry to be stored as if the Z-Axis were up as shown in the right picture. Unity however, the Y-Axis is up as shown in the left picture, meaning that we'll get inaccurate results if we use the meshes as is. To solve this, MeshInfo has a method RotateMesh that can easily rotate MeshInfo objects after they've been created. Another class in the Geometry namespace titled CommonRotations contains the rotation necessary to perform this conversion.</p>
<p>With all this in mind, here is the code to prepare the mesh.</p>
<div class="fragment"><div class="line">{C#}</div>
<div class="line">       // Get Triangle Indexes and Vertices from the Mesh </div>
<div class="line">       int[] tris = PlaneMesh.triangles;</div>
<div class="line">       Vector3[] vertices = PlaneMesh.vertices;</div>
<div class="line"> </div>
<div class="line">       // Send to HumanFactors</div>
<div class="line">       MeshInfo PlaneMeshInfo = new MeshInfo(tris, FlattenVertexArray(vertices));</div>
<div class="line"> </div>
<div class="line">       //Rotate to Z-Up</div>
<div class="line">       PlaneMeshInfo.RotateMesh(CommonRotations.Yup_To_Zup);</div>
</div><!-- fragment --><p>Your end file should look like the following:</p>
<p><img src="../assets/walkthroughs/unity/4_graph_generator/end_of_getting_mesh.png" alt="End Of Getting Mesh" class="inline"/></p>
<p>screenshot, so instead I'll just post the full code in this document here.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Executing the Script</h1>
<h2><a class="anchor" id="autotoc_md36"></a>
Adding References Through the Unity Inspector</h2>
<h2><a class="anchor" id="autotoc_md37"></a>
Comparing Output</h2>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
